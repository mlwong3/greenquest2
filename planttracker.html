<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ç¶ é‡å°‹è¹¤ - æ¤ç‰©ç´€éŒ„</title>
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- å¼•å…¥ FontAwesome åœ–æ¨™ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; touch-action: manipulation; }
        
        /* === ä¿®æ”¹èƒŒæ™¯åœ–ç‰‡ === 
           è«‹å°‡ url('Background.png') ä¸­çš„ Background.png æ›æˆä½ çš„èƒŒæ™¯åœ–ç‰‡æª”å
        */
        .app-bg {
            /* èˆŠçš„æ¼¸å±¤èƒŒæ™¯å·²è¨»è§£ */
            /* background: linear-gradient(180deg, #d1fae5 0%, #10b981 100%); */
            
            background-image: url('Home.png'); /* åœ¨é€™è£¡ä¿®æ”¹èƒŒæ™¯åœ–ç‰‡æª”å */
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        /* å¯µç‰©æµ®å‹•å‹•ç•« */
        .pet-sprite { animation: float 3s ease-in-out infinite; }
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-15px); }
        }

        /* éš±è—æ»¾å‹•æ¢ä½†ä¿ç•™åŠŸèƒ½ */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* æŒ‰éˆ•äº’å‹• */
        .nav-btn { transition: all 0.2s; }
        .nav-btn.active { color: #059669; transform: translateY(-2px); }
        .nav-btn.active i { background-color: #d1fae5; padding: 8px; border-radius: 50%; }

        /* å¡ç‰‡æ¨£å¼ */
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        /* è¼‰å…¥ä¸­å‹•ç•« */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #10b981;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .modal-backdrop { transition: opacity 0.3s ease; opacity: 0; }
        .modal-backdrop.opacity-100 { opacity: 1; }
        .modal-content { transition: transform 0.3s ease, opacity 0.3s ease; }
    </style>
</head>
<body class="app-bg text-emerald-900">

    <div id="app" class="w-full max-w-md mx-auto h-screen flex flex-col relative bg-white/10 backdrop-blur-sm shadow-2xl overflow-hidden">
        
        <!-- ================= 1. ä¸»é ç•Œé¢ (Home) ================= -->
        <div id="view-home" class="view-section flex flex-col h-full">
            <!-- é ‚éƒ¨æ¨™é¡Œ -->
            <header class="pt-6 pb-2 flex justify-between items-center">
                <h1 class="text-2xl font-bold text-white drop-shadow-md tracking-wider">ğŸŒ¿ æ¤ç‰©ç´€éŒ„</h1>
                <button id="switch-scene-btn" class="bg-white/70 backdrop-blur-sm rounded-full px-3 py-2 flex items-center shadow hover:bg-white/90 transition-colors"><span class="text-2xl">ğŸ </span></button>
            </header>

            <!-- ä¸­å¿ƒå¯µç‰©å€ -->
            <div class="flex-grow flex flex-col items-center justify-center relative">
                <!-- 
                   === ä¿®æ”¹å¯µç‰©åœ–ç‰‡ ===
                   è«‹ä¿®æ”¹ä¸‹æ–¹çš„ src å±¬æ€§ã€‚
                   ä¾‹å¦‚ï¼šsrc="my-pet.png" (å¦‚æœåœ–ç‰‡åœ¨åŒä¸€è³‡æ–™å¤¾)
                   æˆ–æ˜¯ src="images/pet.jpg"
                -->
                <img id="pet-image" 
                     src="Pet3.png" 
                     alt="é›»å­å¯µç‰©" 
                     class="pet-sprite w-64 h-64 object-contain drop-shadow-2xl filter brightness-110">
            </div>

            <!-- ä¸»é è£é£¾å…ƒç´  -->
            <div class="h-[20%] w-full bg-gradient-to-t from-emerald-800/20 to-transparent absolute bottom-20 pointer-events-none"></div>
        </div>

        <!-- ================= 2. è³‡æ–™ç•Œé¢ (Data) ================= -->
        <div id="view-data" class="view-section hidden flex flex-col h-full bg-slate-50/90 backdrop-blur-md">
            <!-- é ‚éƒ¨ -->
            <header class="bg-emerald-600 text-white p-4 flex items-center shadow-md z-10">
                <button onclick="switchView('home')" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-emerald-500 transition">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h2 class="flex-grow text-center text-lg font-bold pr-8">æ¤ç‰©è³‡æ–™åº«</h2>
            </header>

            <!-- å…§å®¹å€ -->
            <div class="flex-grow overflow-y-auto no-scrollbar p-6 pb-24 flex flex-col">
                
                <!-- æœå°‹è¼¸å…¥å€ -->
                <div id="data-search-area" class="w-full space-y-4 mb-6">
                    <div class="bg-white p-6 rounded-2xl shadow-sm text-center">
                        <i class="fas fa-search text-emerald-300 text-4xl mb-4"></i>
                        <h3 class="font-bold text-lg mb-2">æŸ¥è©¢æ¤ç‰©è³‡è¨Š</h3>
                        <p class="text-sm text-gray-500 mb-4">è¼¸å…¥æ¤ç‰©åç¨±ï¼Œè®“ AI å¹«ä½ å»ºç«‹æª”æ¡ˆï¼</p>
                        
                        <input type="text" id="plant-search-input" placeholder="ä¾‹å¦‚ï¼šé¾œèƒŒèŠ‹ã€ç«ç‘°..." 
                               class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 mb-4 focus:outline-none focus:border-emerald-500 transition text-center">
                        
                        <button onclick="searchPlantData()" id="search-btn" class="w-full bg-emerald-500 text-white font-bold py-3 rounded-xl shadow-lg active:scale-95 transition flex justify-center items-center">
                            <span>é–‹å§‹æœå°‹</span>
                        </button>
                    </div>
                </div>

                <!-- è¼‰å…¥ä¸­ç‹€æ…‹ -->
                <div id="data-loading" class="hidden flex-col items-center justify-center py-10">
                    <div class="loader mb-4"></div>
                    <p class="text-emerald-600 font-bold animate-pulse">æ­£åœ¨ç¿»é–±æ¤ç‰©ç™¾ç§‘...</p>
                </div>

                <!-- æœå°‹çµæœé¡¯ç¤ºå€ (é è¨­éš±è—) -->
                <div id="data-result-area" class="hidden space-y-6 fade-in">
                    <!-- æ¤ç‰©æ¨™é¡Œ -->
                    <div class="w-full bg-emerald-100 rounded-3xl p-6 text-center relative overflow-hidden shadow-inner">
                        <div class="absolute top-0 left-0 w-full h-2 bg-emerald-400"></div>
                        <h3 id="res-name" class="text-2xl font-bold text-emerald-800 mb-1">æ¤ç‰©åç¨±</h3>
                        <p id="res-scientific" class="text-sm text-emerald-600 italic">Scientific Name</p>
                    </div>

                    <!-- è³‡è¨Šç¶²æ ¼ -->
                    <div class="grid grid-cols-2 gap-4">
                        <div class="glass-panel p-4 flex flex-col items-center text-center">
                            <i class="fas fa-seedling text-2xl text-emerald-500 mb-2"></i>
                            <span class="text-xs text-gray-500">å“ç¨®</span>
                            <span id="res-variety" class="font-bold text-emerald-800 text-sm">-</span>
                        </div>
                        <div class="glass-panel p-4 flex flex-col items-center text-center">
                            <i class="fas fa-sun text-2xl text-orange-400 mb-2"></i>
                            <span class="text-xs text-gray-500">å…‰ç…§</span>
                            <span id="res-light" class="font-bold text-emerald-800 text-sm">-</span>
                        </div>
                        <div class="glass-panel p-4 flex flex-col items-center text-center">
                            <i class="fas fa-tint text-2xl text-blue-400 mb-2"></i>
                            <span class="text-xs text-gray-500">æ¾†æ°´</span>
                            <span id="res-water" class="font-bold text-emerald-800 text-sm">-</span>
                        </div>
                        <div class="glass-panel p-4 flex flex-col items-center text-center">
                            <i class="fas fa-thermometer-half text-2xl text-red-400 mb-2"></i>
                            <span class="text-xs text-gray-500">æº«åº¦</span>
                            <span id="res-temp" class="font-bold text-emerald-800 text-sm">-</span>
                        </div>
                    </div>
                    
                    <div class="glass-panel p-5 bg-yellow-50/80">
                        <h4 class="font-bold text-emerald-800 mb-2 flex items-center"><i class="fas fa-star text-yellow-500 mr-2"></i>ç¨®æ¤å°æŠ€å·§</h4>
                        <p id="res-tips" class="text-sm text-gray-700 leading-relaxed">
                            -
                        </p>
                    </div>

                    <button onclick="resetSearch()" class="w-full text-gray-400 text-sm py-2 hover:text-gray-600">
                        é‡æ–°æœå°‹
                    </button>
                </div>
            </div>
        </div>

        <!-- ================= 3. æ‹æ”ç•Œé¢ (Camera) ================= -->
        <div id="view-camera" class="view-section hidden flex flex-col h-full bg-black">
            <!-- é ‚éƒ¨ -->
            <header class="absolute top-0 left-0 w-full p-4 flex items-center z-20 bg-gradient-to-b from-black/50 to-transparent">
                <button onclick="switchView('home')" class="w-8 h-8 flex items-center justify-center rounded-full text-white hover:bg-white/20 transition">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h2 class="flex-grow text-center text-white text-lg font-bold pr-8">æ‹æ”ç´€éŒ„</h2>
            </header>

            <!-- ç›¸æ©Ÿé è¦½ / ç…§ç‰‡é¡¯ç¤ºå€ -->
            <div class="flex-grow relative bg-gray-800 flex items-center justify-center overflow-hidden">
                <!-- è¦–è¨Šä¸²æµ -->
                <video id="camera-stream" autoplay playsinline class="absolute inset-0 w-full h-full object-cover"></video>
                <!-- æ‹æ”å¾Œçš„ç…§ç‰‡ (é è¨­éš±è—) -->
                <img id="captured-image" class="absolute inset-0 w-full h-full object-cover hidden" alt="Captured">
                
                <!-- ç›¸æ©Ÿ UI (æœªæ‹æ”æ™‚é¡¯ç¤º) -->
                <div id="camera-ui" class="absolute bottom-10 left-0 w-full flex justify-center z-30">
                     <button onclick="takePhoto()" class="w-20 h-20 rounded-full border-4 border-white flex items-center justify-center bg-white/20 active:bg-white/50 transition shadow-lg">
                        <div class="w-16 h-16 bg-white rounded-full"></div>
                     </button>
                </div>
            </div>

            <!-- åº•éƒ¨è¡¨å–® (æ‹æ”å¾Œæ»‘å‡º) -->
            <div id="record-form" class="hidden bg-white rounded-t-3xl p-6 pb-24 z-10 animate-[slideUp_0.3s_ease-out] shadow-[0_-10px_20px_rgba(0,0,0,0.2)] h-[50vh] overflow-y-auto">
                <h3 class="font-bold text-emerald-900 mb-4 flex items-center">
                    <i class="fas fa-edit mr-2"></i> ç´€éŒ„ç‹€æ…‹
                </h3>
                
                <div class="space-y-4">
                    <!-- å¿«é€Ÿæ¨™ç±¤ -->
                    <div class="grid grid-cols-2 gap-3">
                        <div class="bg-emerald-50 p-3 rounded-xl">
                            <span class="text-xs text-emerald-800 block mb-1"><i class="fas fa-leaf mr-1"></i>è‘‰ç‰‡ç‹€æ…‹</span>
                            <select id="leaf-status" class="w-full bg-transparent font-bold text-emerald-600 outline-none border-b border-emerald-200 pb-1">
                                <option value="å¥åº·ç¿ ç¶ ">å¥åº·ç¿ ç¶ </option>
                                <option value="è¼•å¾®ç™¼é»ƒ">è¼•å¾®ç™¼é»ƒ</option>
                                <option value="æœ‰æ–‘é»">æœ‰æ–‘é»</option>
                                <option value="æ¯èä¸‹å‚">æ¯èä¸‹å‚</option>
                                <option value="èŸ²å®³è·¡è±¡">èŸ²å®³è·¡è±¡</option>
                            </select>
                        </div>
                        <div class="bg-blue-50 p-3 rounded-xl">
                            <span class="text-xs text-blue-800 block mb-1"><i class="fas fa-water mr-1"></i>åœŸå£¤ç‹€æ…‹</span>
                            <select id="soil-status" class="w-full bg-transparent font-bold text-blue-600 outline-none border-b border-blue-200 pb-1">
                                <option value="æ¿•æ½¤">æ¿•æ½¤</option>
                                <option value="é©ä¸­">é©ä¸­</option>
                                <option value="ä¹¾ç‡¥">ä¹¾ç‡¥</option>
                                <option value="éå¸¸ä¹¾ç‡¥">éå¸¸ä¹¾ç‡¥</option>
                            </select>
                        </div>
                    </div>

                    <!-- å‚™è¨»æ¬„ -->
                    <div>
                        <label class="text-xs text-gray-500 mb-1 block">å‚™è¨»ç­†è¨˜</label>
                        <textarea id="record-notes" rows="2" placeholder="ä»Šå¤©æ¤ç‰©çœ‹èµ·ä¾†..." 
                                  class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 text-sm focus:outline-none focus:border-emerald-500 resize-none"></textarea>
                    </div>

                    <div class="flex gap-3 pt-2">
                        <button onclick="retakePhoto()" class="flex-1 bg-gray-100 text-gray-600 font-bold py-3 rounded-xl hover:bg-gray-200 transition">
                            é‡æ‹
                        </button>
                        <button onclick="saveRecord()" class="flex-[2] bg-emerald-500 text-white font-bold py-3 rounded-xl shadow-lg shadow-emerald-200 active:scale-95 transition">
                            å„²å­˜ç´€éŒ„
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ================= 4. ç´€éŒ„ç•Œé¢ (Records) ================= -->
        <div id="view-records" class="view-section hidden flex flex-col h-full bg-gray-50/90 backdrop-blur-md">
            <!-- é ‚éƒ¨ -->
            <header class="bg-white p-4 flex items-center shadow-sm z-10 sticky top-0">
                <button onclick="switchView('home')" class="w-8 h-8 flex items-center justify-center rounded-full text-gray-600 hover:bg-gray-100 transition">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h2 class="flex-grow text-center text-emerald-900 text-lg font-bold pr-8">æˆé•·æ—¥èªŒ</h2>
            </header>

            <!-- åˆ—è¡¨å€ -->
            <div class="flex-grow overflow-y-auto no-scrollbar p-4 space-y-4 pb-24" id="records-container">
                <!-- é è¨­ç‚ºç©ºï¼Œç­‰å¾… Javascript å¡«å…… -->
                <div id="empty-state" class="flex flex-col items-center justify-center h-64 text-gray-400 opacity-60">
                    <i class="fas fa-camera text-4xl mb-3"></i>
                    <p>å°šæœªæœ‰ç´€éŒ„ï¼Œå¿«å»æ‹æ”å§ï¼</p>
                </div>
            </div>
        </div>

        <!-- ================= åº•éƒ¨å°èˆªæ¬„ (å…¨åŸŸ) ================= -->
        <nav id="main-nav" class="absolute bottom-0 left-0 w-full bg-white/90 backdrop-blur-md border-t border-gray-100 px-6 py-3 flex justify-between items-center z-50 rounded-t-3xl shadow-[0_-5px_10px_rgba(0,0,0,0.02)] transition-transform duration-300">
            <button onclick="switchView('data')" class="nav-btn flex flex-col items-center text-gray-400 space-y-1" id="nav-data">
                <i class="fas fa-book text-xl"></i>
                <span class="text-xs font-medium">è³‡æ–™</span>
            </button>
            
            <!-- æ‹æ”æŒ‰éˆ• -->
            <button onclick="switchView('camera')" class="nav-btn flex flex-col items-center text-gray-400 -mt-6" id="nav-camera">
                <div class="w-16 h-16 bg-emerald-500 rounded-full flex items-center justify-center shadow-lg shadow-emerald-200 text-white text-2xl border-4 border-white">
                    <i class="fas fa-camera"></i>
                </div>
                <span class="text-xs font-medium mt-1">æ‹æ”</span>
            </button>

            <button onclick="switchView('records')" class="nav-btn flex flex-col items-center text-gray-400 space-y-1" id="nav-records">
                <i class="fas fa-clipboard-list text-xl"></i>
                <span class="text-xs font-medium">ç´€éŒ„</span>
            </button>
        </nav>

    </div>

    <div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-50 modal-backdrop flex items-center justify-center p-4 z-50">
        <div class="modal-content bg-white rounded-2xl shadow-xl p-6 text-center max-w-sm mx-auto transform scale-95 opacity-0"></div>
    </div>

    <script>
        // === å…¨åŸŸè®Šæ•¸ ===
        const state = {
            apiKey: "", // API Key æœƒåœ¨åŸ·è¡Œæ™‚è‡ªå‹•æ³¨å…¥
            records: [] // å„²å­˜ç´€éŒ„çš„é™£åˆ—
        };

        // === 1. ä»‹é¢åˆ‡æ›é‚è¼¯ ===
        function switchView(viewName) {
            // éš±è—æ‰€æœ‰ä»‹é¢
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            
            // é¡¯ç¤ºç›®æ¨™ä»‹é¢
            document.getElementById(`view-${viewName}`).classList.remove('hidden');

            // è™•ç†å°èˆªæ¬„é¡¯ç¤º/éš±è—
            const nav = document.getElementById('main-nav');
            if (viewName === 'camera') {
                nav.classList.add('translate-y-full'); // å°‡å°èˆªæ¬„ç§»å‡ºç•«é¢
                setTimeout(() => nav.classList.add('hidden'), 300); // å‹•ç•«çµæŸå¾Œéš±è—
            } else {
                nav.classList.remove('hidden');
                setTimeout(() => nav.classList.remove('translate-y-full'), 10); // ç¢ºä¿ç§»é™¤ hidden å¾Œå†æ»‘å…¥
            }

            // æ›´æ–°å°èˆªæ¬„ç‹€æ…‹
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            
            if(viewName !== 'home' && viewName !== 'camera') {
                const navId = `nav-${viewName}`;
                const navEl = document.getElementById(navId);
                if(navEl) navEl.classList.add('active');
            }

            // ç‰¹æ®Šè™•ç†ï¼šé€²å…¥ç›¸æ©Ÿé é¢æ™‚å•Ÿå‹•ç›¸æ©Ÿ
            if(viewName === 'camera') {
                startCamera();
            } else {
                stopCamera();
            }
        }

        // === 2. è³‡æ–™æœå°‹é‚è¼¯ (Gemini API) ===
        async function searchPlantData() {
            const input = document.getElementById('plant-search-input');
            const plantName = input.value.trim();
            
            if(!plantName) {
                alert("è«‹è¼¸å…¥æ¤ç‰©åç¨±ï¼");
                return;
            }

            // UI ç‹€æ…‹åˆ‡æ›
            document.getElementById('data-search-area').classList.add('hidden');
            document.getElementById('data-loading').classList.remove('hidden');
            document.getElementById('data-loading').classList.add('flex');

            const prompt = `ä½ æ˜¯æ¤ç‰©å°ˆå®¶ã€‚è«‹é‡å°æ¤ç‰©ã€Œ${plantName}ã€æä¾› JSON æ ¼å¼çš„è³‡è¨Šã€‚
            æ ¼å¼è¦æ±‚ï¼š{"variety": "å“ç¨®/ç§‘åˆ¥", "scientificName": "å­¸å", "light": "å…‰ç…§éœ€æ±‚ç°¡è¿°", "water": "æ¾†æ°´é »ç‡ç°¡è¿°", "temp": "æº«åº¦ç¯„åœ", "tips": "ä¸€å¥ç¨®æ¤å°æŠ€å·§"}
            å¦‚æœæ‰¾ä¸åˆ°ï¼Œè«‹å›å‚³ nullã€‚è«‹ä½¿ç”¨ç¹é«”ä¸­æ–‡ã€‚`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${state.apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }]
                    })
                });
                
                const result = await response.json();
                const text = result.candidates[0].content.parts[0].text;
                // æ¸…ç† markdown æ¨™è¨˜ä»¥é˜²è¬ä¸€
                const jsonStr = text.replace(/```json|```/g, '').trim();
                const data = JSON.parse(jsonStr);

                if(data) {
                    // å¡«å…¥è³‡æ–™
                    document.getElementById('res-name').innerText = plantName;
                    document.getElementById('res-variety').innerText = data.variety;
                    document.getElementById('res-scientific').innerText = data.scientificName;
                    document.getElementById('res-light').innerText = data.light;
                    document.getElementById('res-water').innerText = data.water;
                    document.getElementById('res-temp').innerText = data.temp;
                    document.getElementById('res-tips').innerText = data.tips;

                    // é¡¯ç¤ºçµæœ
                    document.getElementById('data-loading').classList.add('hidden');
                    document.getElementById('data-loading').classList.remove('flex');
                    document.getElementById('data-result-area').classList.remove('hidden');
                } else {
                    throw new Error("æŸ¥ç„¡è³‡æ–™");
                }

            } catch (e) {
                console.error(e);
                alert("æŠ±æ­‰ï¼Œæ‰¾ä¸åˆ°è©²æ¤ç‰©çš„è³‡æ–™ï¼Œè«‹é‡è©¦ã€‚");
                resetSearch();
            }
        }

        function resetSearch() {
            document.getElementById('data-search-area').classList.remove('hidden');
            document.getElementById('data-loading').classList.add('hidden');
            document.getElementById('data-loading').classList.remove('flex');
            document.getElementById('data-result-area').classList.add('hidden');
            document.getElementById('plant-search-input').value = "";
        }


        // === 3. ç›¸æ©Ÿèˆ‡æ‹ç…§é‚è¼¯ ===
        let stream = null;
        const video = document.getElementById('camera-stream');
        const img = document.getElementById('captured-image');
        const ui = document.getElementById('camera-ui');
        const form = document.getElementById('record-form');

        async function startCamera() {
            // é‡ç½®ç‹€æ…‹
            img.classList.add('hidden');
            video.classList.remove('hidden');
            ui.classList.remove('hidden');
            form.classList.add('hidden');

            try {
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "environment" } 
                });
                video.srcObject = stream;
            } catch (err) {
                console.error("ç›¸æ©Ÿå•Ÿå‹•å¤±æ•—", err);
                alert("ç„¡æ³•å•Ÿå‹•ç›¸æ©Ÿï¼Œè«‹æª¢æŸ¥æ¬Šé™ã€‚");
            }
        }

        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
        }

        function takePhoto() {
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0);
            
            // é¡¯ç¤ºç…§ç‰‡
            img.src = canvas.toDataURL('image/png');
            img.classList.remove('hidden');
            video.classList.add('hidden');
            
            // åˆ‡æ› UI
            ui.classList.add('hidden');
            form.classList.remove('hidden');
            
            // æš«åœä¸²æµä»¥çœé›»
            stopCamera();
        }

        function retakePhoto() {
            startCamera();
        }

        // === 4. ç´€éŒ„å„²å­˜é‚è¼¯ ===
        function saveRecord() {
            const leaf = document.getElementById('leaf-status').value;
            const soil = document.getElementById('soil-status').value;
            const notes = document.getElementById('record-notes').value;
            const photoSrc = img.src;
            
            const now = new Date();
            const timeStr = `${now.getMonth()+1}/${now.getDate()} ${now.getHours()}:${now.getMinutes().toString().padStart(2, '0')}`;
            
            // å»ºç«‹ç´€éŒ„ç‰©ä»¶
            const newRecord = {
                id: Date.now(),
                photo: photoSrc,
                time: timeStr,
                leaf: leaf,
                soil: soil,
                notes: notes || "ç„¡å‚™è¨»"
            };

            // åŠ åˆ°åˆ—è¡¨å‰ç«¯
            state.records.unshift(newRecord);
            renderRecords();

            // é‡ç½®è¡¨å–®
            document.getElementById('record-notes').value = "";
            
            // è·³è½‰
            switchView('records');
        }

        function renderRecords() {
            const container = document.getElementById('records-container');
            
            if (state.records.length === 0) {
                container.innerHTML = `
                <div id="empty-state" class="flex flex-col items-center justify-center h-64 text-gray-400 opacity-60">
                    <i class="fas fa-camera text-4xl mb-3"></i>
                    <p>å°šæœªæœ‰ç´€éŒ„ï¼Œå¿«å»æ‹æ”å§ï¼</p>
                </div>`;
                return;
            }

            container.innerHTML = state.records.map(r => `
                <div class="bg-white p-4 rounded-2xl shadow-sm flex items-start gap-4 border-l-4 border-emerald-400">
                    <div class="w-20 h-20 bg-gray-200 rounded-xl overflow-hidden flex-shrink-0 relative">
                        <img src="${r.photo}" class="w-full h-full object-cover">
                    </div>
                    <div class="flex-grow">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <h4 class="font-bold text-gray-800">æ¤ç‰©ç´€éŒ„</h4>
                                <p class="text-xs text-gray-400">${r.time}</p>
                            </div>
                        </div>
                        <div class="text-sm text-gray-600 space-y-1">
                            <div class="flex items-center gap-2">
                                <span class="text-xs bg-emerald-100 text-emerald-600 px-2 py-0.5 rounded">è‘‰: ${r.leaf}</span>
                                <span class="text-xs bg-blue-100 text-blue-600 px-2 py-0.5 rounded">åœŸ: ${r.soil}</span>
                            </div>
                            <p class="text-xs text-gray-500 mt-2 border-t border-gray-100 pt-1">${r.notes}</p>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function showModal(contentHtml, onClose = () => {}) {
            const modal = document.getElementById('modal');
            const modalContent = modal.querySelector('.modal-content');
            modalContent.innerHTML = contentHtml;
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.add('opacity-100');
                modalContent.classList.remove('scale-95', 'opacity-0');
                modalContent.classList.add('scale-100', 'opacity-100');
            }, 10);
            
            const closeBtn = modalContent.querySelector('.modal-close-btn');
            if (closeBtn) {
                const closeHandler = () => {
                    hideModal();
                    onClose();
                };
                closeBtn.addEventListener('click', closeHandler);
            }
        }

        function hideModal() {
            const modal = document.getElementById('modal');
            const modalContent = modal.querySelector('.modal-content');
            modal.classList.remove('opacity-100');
            modalContent.classList.remove('scale-100', 'opacity-100');
            modalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        function showSwitchSceneModal(targetUrl) {
            showModal(`
                <div class="text-6xl mb-4">ğŸŒ¿</div>
                <h3 class="text-2xl font-bold mb-2">æ˜¯å¦åˆ‡æ›å ´æ™¯ï¼Ÿ</h3>
                <p class="text-gray-600 mb-6">ç¢ºå®šè¦åˆ‡æ›åˆ°å¦ä¸€å€‹å ´æ™¯å—ï¼Ÿ</p>
                <div class="flex gap-4 justify-center">
                    <button class="modal-close-btn btn bg-gray-500 text-white font-bold py-2 px-6 rounded-full" onclick="hideModal()">å¦</button>
                    <button class="btn bg-emerald-500 text-white font-bold py-2 px-6 rounded-full" onclick="window.location.href='${targetUrl}'">æ˜¯</button>
                </div>
            `);
        }

        // Add event listener for switch scene button
        document.getElementById('switch-scene-btn').addEventListener('click', () => showSwitchSceneModal('index.html'));
    </script>
</body>
</html>
